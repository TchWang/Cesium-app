<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cesium-app</title>
    <script type="text/javascript" src="./scripts/Cesium/Cesium.js"></script>
    <script type="text/javascript" src="./scripts/cesium-navigation-development/dist/standalone/viewerCesiumNavigationMixin.js"></script>
    <link rel="stylesheet" href="./scripts/Cesium/Widgets/widgets.css">
    <style>
        html, body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }

        /* 罗盘定位 */
        .compass {
            position: absolute;
            left: 2%;
            top: 2%;
        }

        /* 比例尺位置 */
        .distance-legend {
            position: absolute;
            left: 2%;
            bottom: 6%;
        }

        /* 缩放位置 */
        .navigation-controls {
            position: absolute;
            bottom: 10%;
            right: 2%;
        } 
    </style>
</head>
<body>
    <div id="cesiumcontainer" style="height: 100%;"></div>
    <div id="latlng_show" style=height:5%;position:absolute;bottom:10%;right:5%;z-index:1;font-size:1%;">  
        <div style="width:100px;height:30px;float:left;">  
             <font size="3" color="white">经度：<span id="longitude_show"></span></font>  
        </div>  
        <div style="width:100px;height:30px;float:left;">  
             <font size="3" color="white">纬度：<span id="latitude_show"></span></font>  
        </div>  
        <div style="width:140px;height:30px;float:left;">  
             <font size="3" color="white">视高：<span id="altitude_show"></span>km</font>  
        </div>  
    </div>
    <script>
        
        // 定位功能初始化
        
        var longitude, latitude, altitude;
        longitude=116.0;
        latitude=40.0;
        altitude=200;

        function Location() {};
        
        Location.prototype.m_getLocation = function (callback) {
            var options = {
                enableHighAccuracy: true,
                maximumAge: 1000
            };
            this.callback = Object.prototype.toString.call(callback) == "[object Function]" ?
                callback : function (address) {
                    alert(address.province + address.city);
                    console.log("getocation(callbackFunction) 可获得定位信息对象");
                };
            
            var self = this;
            self.gotlocation = 0;
            if (navigator.geolocation) {
                //浏览器支持geolocation
                navigator.geolocation.getCurrentPosition(function (position) {
                    //经度
                    var longitude = position.coords.longitude;
                    //纬度
                    var latitude = position.coords.latitude;
                    //海拔
                    var altitude = position.coords.altitude!=null?position.coords.altitude:200;
                    
                    self.gotlocation = 1;
                    
                    self.callback([longitude,latitude,altitude]);
                    //self.loadMapApi(longitude, latitude);
                }, self.onError, options);
            } else {
                //浏览器不支持geolocation
            }
        };

        // Location.prototype.loadMapApi = function (longitude, latitude) {
        //     var self = this;
        //     var oHead = document.getElementsByTagName('HEAD').item(0);
        //     var oScript = document.createElement("script");
        //     oScript.type = "text/javascript";
        //     oScript.src = "http://api.map.baidu.com/getscript?v=2.0&ak=A396783ee700cfdb9ba1df281ce36862&services=&t=20140930184510";
        //     oHead.appendChild(oScript);
        //     oScript.onload = function (date) {
        //         var point = new BMap.Point(longitude, latitude);
        //         var gc = new BMap.Geocoder();
        //         gc.getLocation(point, function (rs) {
        //             var addComp = rs.addressComponents;
        //             self.callback(addComp);
        //         });
        //     }
        // };

        Location.prototype.onError = function (error) {
            switch (error.code) {
            case 1:
                alert("位置服务被拒绝");
                break;Z
            case 2:
                alert("暂时获取不到位置信息");
                break;
            case 3:
                alert("获取信息超时");
                break;
            case 4:
                alert("未知错误");
                break;
            }
        };

        //调用
        var local = new Location();
        
    </script>
    <script>
        
        // cesium插件初始化

        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI2YzIzZjFkYi01YzU2LTQ1YmEtYWIzOC00MzVhNjAzY2E2MDEiLCJpZCI6ODMyMDEsImlhdCI6MTY0NTQzMDEzMX0.g62phdhvaMrDUyvw-qVayetbr39pVAqS5Ka1ipdSR04'

        var image = new Cesium.ArcGisMapServerImageryProvider({
            url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
        });
        var terrain = new Cesium.createWorldTerrain({           
            requestWaterMask:true,           
            requestVertexNormals:true       
        }); 

        var viewer = new Cesium.Viewer('cesiumcontainer', {
            //需要进行可视化的数据源的集合
            animation: false, //是否显示动画控件
            shouldAnimate : true,
            homeButton: false, //是否显示Home按钮
            fullscreenButton: false, //是否显示全屏按钮
            baseLayerPicker: false, //是否显示图层选择控件
            geocoder: false, //是否显示地名查找控件
            timeline: false, //是否显示时间线控件
            sceneModePicker: true, //是否显示投影方式控件
            navigationHelpButton: false, //是否显示帮助信息控件
            infoBox: false, //是否显示点击要素之后显示的信息
            requestRenderMode: true, //启用请求渲染模式
            scene3DOnly: false, //每个几何实例将只能以3D渲染以节省GPU内存
            sceneMode: 3, //初始场景模式 1 2D模式 2 2D循环模式 3 3D模式  Cesium.SceneMode
            fullscreenElement: document.body, //全屏时渲染的HTML元素 暂时没发现用处

            imageryProvider: image,
            terrainProvider: terrain
        });

        var options = {};
        options.defaultResetView = Cesium.Rectangle.fromDegrees(71, 3, 90, 14);
        // Only the compass will show on the map
        options.enableCompass = true;
        options.enableZoomControls = false;
        options.enableDistanceLegend = true;
        options.enableCompassOuterRing= false;
        viewer.extend(Cesium.viewerCesiumNavigationMixin, options);

        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(103.84, 31.15, 17850000),
            orientation: {
                heading : Cesium.Math.toRadians(348.4202942851978),
                pitch : Cesium.Math.toRadians(-89.74026687972041),
                roll : Cesium.Math.toRadians(0)
            },
            complete:function callback() {
                
                // 定位完成之后的回调函数
            }
        });

        var longitude_show=document.getElementById('longitude_show');  
        var latitude_show=document.getElementById('latitude_show');  
        var altitude_show=document.getElementById('altitude_show');  
        var canvas=viewer.scene.canvas;  
        //具体事件的实现  
        var ellipsoid=viewer.scene.globe.ellipsoid;  
        var handler = new Cesium.ScreenSpaceEventHandler(canvas);  
        handler.setInputAction(function(movement){  
            //捕获椭球体，将笛卡尔二维平面坐标转为椭球体的笛卡尔三维坐标，返回球体表面的点  
            var cartesian=viewer.camera.pickEllipsoid(movement.endPosition, ellipsoid);  
            if(cartesian){  
                //将笛卡尔三维坐标转为地图坐标（弧度）  
                var cartographic=viewer.scene.globe.ellipsoid.cartesianToCartographic(cartesian);  
                //将地图坐标（弧度）转为十进制的度数  
                var lat_String=Cesium.Math.toDegrees(cartographic.latitude).toFixed(4);  
                var log_String=Cesium.Math.toDegrees(cartographic.longitude).toFixed(4);  
                var alti_String=(viewer.camera.positionCartographic.height/1000).toFixed(2);  
                longitude_show.innerHTML=log_String;  
                latitude_show.innerHTML=lat_String;  
                altitude_show.innerHTML=alti_String;  
            }  
        },Cesium.ScreenSpaceEventType.MOUSE_MOVE); 

    </script>
    <script>

        // 位置获取及跳转

        local.m_getLocation(function (res) {
            //此处就是返回的地理位置信息
            //alert(res);
            window.longitude = res[0];
            window.latitude = res[1];
            window.altitude = res[2];
            //把返回的对象转为字符串了，自己根据需求截取下就好
            //var resstr = JSON.stringify(res);
            //alert(resstr);
        });

        setTimeout(function (){
            
            // 标签

            var CP = viewer.entities.add({
                name : 'CP',
                position : Cesium.Cartesian3.fromDegrees(longitude,latitude),
                point : {
                    pixelSize : 5,
                    color : Cesium.Color.WHITE,
                    outlineColor : Cesium.Color.YELLOW,
                    outlineWidth : 2
                },
                label : {
                    text : 'Current Position',
                    font : '14pt monospace',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    color : Cesium.Color.WHITE,
                    outlineColor : Cesium.Color.YELLOW,
                    outlineWidth : 2,
                    verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset : new Cesium.Cartesian2(0, -9)
                }
            });

            var XY = viewer.entities.add({
                name : 'XY',
                rectangle : {
                    coordinates : Cesium.Rectangle.fromDegrees(longitude-0.1175, latitude-0.09, longitude+0.1175, latitude+0.09),
                    material : new Cesium.GridMaterialProperty({
                        color : Cesium.Color.RED,
                        cellAlpha : 0,
                        lineCount : new Cesium.Cartesian2(200, 200),
                        lineThickness : new Cesium.Cartesian2(1.2, 1.2)
                    })
                }
            });

            if (local.gotlocation == 0) {

                alert("未获取到位置数据，使用默认位置");
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(longitude,latitude-0.032,1500),
                    orientation: {
                        heading : 0,
                        pitch : Cesium.Math.toRadians(-25),
                        roll : Cesium.Math.toRadians(0)
                    }
                });

            }else{

                //alert([longitude,latitude,altitude]);
                setInterval(function(){

                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(longitude,latitude-0.032,1500),
                        orientation: {
                            heading : 0,
                            pitch : Cesium.Math.toRadians(-25),
                            roll : Cesium.Math.toRadians(0)
                        }
                    });

                    local.m_getLocation(function (res) {
                        //此处就是返回的地理位置信息
                        //alert(res);
                        longitude = res[0];
                        latitude = res[1];
                        altitude = res[2];
                        //把返回的对象转为字符串了，自己根据需求截取下就好
                        //var resstr = JSON.stringify(res);
                        //alert(resstr);
                    });

                    CP.position = Cesium.Cartesian3.fromDegrees(longitude,latitude);

                },1000);

            }

        }, 3000);
      
    </script>

</body>
</html>
